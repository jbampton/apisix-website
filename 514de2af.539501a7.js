(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{82:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return r})),a.d(t,"metadata",(function(){return o})),a.d(t,"toc",(function(){return l})),a.d(t,"default",(function(){return p}));var n=a(3),s=a(7),i=(a(0),a(106)),r={title:"Run Ingress APISIX on Amazon EKS",author:"Chao Zhang",authorURL:"https://github.com/tokers",authorImageURL:"https://avatars0.githubusercontent.com/u/10428333?s=60&v=4"},o={permalink:"/blog/2021/01/21/run-ingress-apisix-on-amazon-eks",source:"@site/blog/2021-01-21-run-ingress-apisix-on-amazon-eks.md",description:"@Chao Zhang, Apache APISIX Comitter from Shenzhen Zhiliu Technology Co.",date:"2021-01-21T00:00:00.000Z",tags:[],title:"Run Ingress APISIX on Amazon EKS",readingTime:4.12,truncated:!1,nextItem:{title:"\u521d\u63a2 Kubernetes Service APIs",permalink:"/blog/2020/12/18/a-first-look-at-kubernetes-service-api"}},l=[{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Install Apache APISIX",id:"install-apache-apisix",children:[]},{value:"Install apisix-ingress-controller",id:"install-apisix-ingress-controller",children:[]},{value:"Test",id:"test",children:[]},{value:"See Also",id:"see-also",children:[]}],c={toc:l};function p(e){var t=e.components,a=Object(s.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},c,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},Object(i.b)("a",{parentName:"p",href:"https://github.com/tokers"},"@Chao Zhang"),", Apache APISIX Comitter from ",Object(i.b)("a",{parentName:"p",href:"https://www.apiseven.com/"},"Shenzhen Zhiliu Technology Co.")),Object(i.b)("p",{parentName:"blockquote"},"Source:"),Object(i.b)("ul",{parentName:"blockquote"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://github.com/apache/apisix"},"https://github.com/apache/apisix")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://github.com/apache/apisix-helm-chart"},"https://github.com/apache/apisix-helm-chart")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://github.com/apache/apisix-ingress-controller"},"https://github.com/apache/apisix-ingress-controller")))),Object(i.b)("p",null,"This post is based on ",Object(i.b)("a",{parentName:"p",href:"https://github.com/apache/apisix-ingress-controller/blob/master/docs/deployments/aws.md"},"Install Ingress APISIX on Amazon EKS"),"."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"})),Object(i.b)("p",null,"Amazon Elastic Kubernetes Service (",Object(i.b)("a",{parentName:"p",href:"https://amazonaws-china.com/eks/?whats-new-cards.sort-by=item.additionalFields.postDateTime&whats-new-cards.sort-order=desc&eks-blogs.sort-by=item.additionalFields.createdDate&eks-blogs.sort-order=desc"},"Amazon EKS"),") gives you the flexibility to start, run, and scale Kubernetes applications in the AWS cloud or on-premises. This article explains how to run Ingress APISIX on it."),Object(i.b)("p",null,"Ingress APISIX brings good features (traffic splitting, multiple protocols, authentication and etc) of Apache APISIX to Kubernetes, with a well-designed Controller componment to drive it, which helps users to achieve complex demands for the north-south traffic."),Object(i.b)("h2",{id:"prerequisites"},"Prerequisites"),Object(i.b)("p",null,"Before you go ahead, make sure you have an available EKS cluster on Amazon AWS. If you don't have one, please create it according to the guide."),Object(i.b)("p",null,"You shall have kubectl tool in your own environment, set the context to your EKS cluster by running:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},"aws eks update-kubeconfig --name <your eks cluster name> --region <your region>\n")),Object(i.b)("p",null,"After the Kubernetes cluster is ready, creating the namespace ingress-apisix, all subsequent resources will be created at this namespace."),Object(i.b)("p",null,"kubectl create namespace ingress-apisix"),Object(i.b)("p",null,"We use ",Object(i.b)("a",{parentName:"p",href:"https://helm.sh/"},"Helm")," to deploy all components in Ingress APISIX (",Object(i.b)("a",{parentName:"p",href:"https://github.com/apache/apisix"},"Apache APISIX")," and ",Object(i.b)("a",{parentName:"p",href:"https://github.com/apache/apisix-ingress-controller"},"apisix-ingress-controller"),"), so please also install Helm according to its installation guide. The helm charts for Apache APISIX and apisix-ingress-controller are in apache/apisix-helm-chart and apache/apisix-ingress-controller, clone them to get the charts."),Object(i.b)("h2",{id:"install-apache-apisix"},"Install Apache APISIX"),Object(i.b)("p",null,"Apache APISIX as the proxy plane of apisix-ingress-controller, should be deployed in advance."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},'cd /path/to/apisix-helm-chart\nhelm repo add bitnami https://charts.bitnami.com/bitnami\nhelm dependency update ./chart/apisix\nhelm install apisix ./chart/apisix \\\n  --set gateway.type=LoadBalancer \\\n  --set allow.ipList="{0.0.0.0/0}" \\\n  --namespace ingress-apisix\nkubectl get service --namespace ingress-apisix\n')),Object(i.b)("p",null,"The above commands created two Kubernetes Service resources, one is ",Object(i.b)("inlineCode",{parentName:"p"},"apisix-gateway"),", which processes the real traffic; another is ",Object(i.b)("inlineCode",{parentName:"p"},"apisix-admin"),", which acts as the control plane to process all the configuration changes. Here we created the ",Object(i.b)("inlineCode",{parentName:"p"},"apisix-gateway")," as a ",Object(i.b)("inlineCode",{parentName:"p"},"LoadBalancer")," type Service, which resorts the ",Object(i.b)("a",{parentName:"p",href:"https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html"},"AWS Network Balancer")," to expose it to the Internet. You can find the load balancer hostname by the following command:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},"kubectl get service apisix-gateway \\\n--namespace ingress-apisix \\\n-o jsonpath='{.status.loadBalancer.ingress[].hostname}'\n")),Object(i.b)("p",null," Another thing should be concerned that the ",Object(i.b)("inlineCode",{parentName:"p"},"allow.ipList")," field should be customized according to the ",Object(i.b)("a",{parentName:"p",href:"https://amazonaws-china.com/premiumsupport/knowledge-center/eks-multiple-cidr-ranges/"},"EKS CIDR Ranges")," in your EKS cluster, so that the apisix-ingress-controller can be authorized by Apache APISIX (for the resources pushing)."),Object(i.b)("p",null,"See value.yaml](",Object(i.b)("a",{parentName:"p",href:"https://github.com/apache/apisix-helm-chart/blob/master/chart/apisix/values.yaml"},"https://github.com/apache/apisix-helm-chart/blob/master/chart/apisix/values.yaml"),") to learn all the configuration items if you have other requirements."),Object(i.b)("h2",{id:"install-apisix-ingress-controller"},"Install apisix-ingress-controller"),Object(i.b)("p",null,"After Apache APISIX is deployed successfully, now it's time to install the controller component."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},"cd /path/to/apisix-ingress-controller\n# install base resources, e.g. ServiceAccount.\nhelm install ingress-apisix-base -n ingress-apisix ./charts/base\n# install apisix-ingress-controller\nhelm install ingress-apisix ./charts/ingress-apisix \\\n  --set ingressController.image.tag=dev \\\n  --set ingressController.config.apisix.baseURL=http://apisix-admin:9180/apisix/admin \\\n  --set ingressController.config.apisix.adminKey={YOUR ADMIN KEY} \\\n  --namespace ingress-apisix\n")),Object(i.b)("p",null,"The ingress-apisix-base chart installed some basic dependencies for apisix-ingress-controller, such as ServiceAccount, its exclusive CRDs and etc."),Object(i.b)("p",null,"The ingress-apisix chart guides us how to install the controller itself, you can change the image tag to the desired release version, also the value of ",Object(i.b)("inlineCode",{parentName:"p"},"ingressController.config.apisix.adminKey")," in abovementioned commands should be filled according to your pratical usage (and be sure the admin key is same as the on in Apache APISIX deployment). See ",Object(i.b)("a",{parentName:"p",href:"https://github.com/apache/apisix-ingress-controller/blob/master/charts/ingress-apisix/values.yaml"},"value.yaml")," to learn all the configuration items if you have other requirements."),Object(i.b)("p",null,"Now try to open your EKS console, choosing your cluster and clicking the Workloads tag, you shall see all pods of Apache APISIX, etcd and apisix-ingress-controller are ready."),Object(i.b)("h2",{id:"test"},"Test"),Object(i.b)("p",null,"Now we have deployed all components in Ingress APISIX, it's important to check whether it runs well. We will deploy a httpbin service and ask Apache APISIX to route all requests with Host ",Object(i.b)("inlineCode",{parentName:"p"},'"local.httpbin.org"')," to it."),Object(i.b)("p",null,"The first step we should do is created the httpbin workload and expose it."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},"kubectl run httpbin --image kennethreitz/httpbin --port 80\nkubectl expose pod httpbin --port 80\n")),Object(i.b)("p",null,"In order to let Apache APISIX routes requests correctly, we need create an ApisixRoute resource to drive it."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},"# ar-httpbin.yaml\napiVersion: apisix.apache.org/v1\nkind: ApisixRoute\nmetadata:\n  name: httpserver-route\nspec:\n  rules:\n  - host: local.httpbin.org\n    http:\n      paths:\n      - backend:\n          serviceName: httpbin\n          servicePort: 80\n        path: /*\n")),Object(i.b)("p",null,"The above ApisixRoute resource asks Apache APISIX to route requests which Host header is ",Object(i.b)("inlineCode",{parentName:"p"},'"local.httpbin.org"')," to the httpbin backend (the one we just created)."),Object(i.b)("p",null,"Now try to apply it, note the service and the ApisixRoute resource should be put in the same namespace., crossing namespaces is not allowed in apisix-ingress-controller."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f ar-httpbin.yaml\n")),Object(i.b)("p",null,"Test it by a simple curl call from a place where the Apache APISIX service is reachable."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},'$ curl http://{apisix-gateway-ip}:{apisix-gateway-port}/headers -s -H \'Host: local.httpbin.org\'\n\n{\n  "headers": {\n    "Accept": "*/*",\n    "Host": "httpbin.org",\n    "User-Agent": "curl/7.64.1",\n    "X-Amzn-Trace-Id": "Root=1-5ffc3273-2928e0844e19c9810d1bbd8a"\n  }\n}\n')),Object(i.b)("p",null,"If the Serivce type is ",Object(i.b)("inlineCode",{parentName:"p"},"ClusterIP,")," you have to login to a pod in the EKS cluster, then accessing Apache APISIX with its ",Object(i.b)("inlineCode",{parentName:"p"},"ClusterIP")," or Service FQDN. If it was exposed (no matter ",Object(i.b)("inlineCode",{parentName:"p"},"NodePort")," or ",Object(i.b)("inlineCode",{parentName:"p"},"LoadBalancer"),"), just accessing its outside reachable endpoint."),Object(i.b)("h2",{id:"see-also"},"See Also"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://www.apiseven.com/zh/blog/a-first-look-at-kubernetes-service-api"},"https://www.apiseven.com/zh/blog/a-first-look-at-kubernetes-service-api")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"https://www.apiseven.com/zh/blog/another-way-to-implement-envoy-filter"},"https://www.apiseven.com/zh/blog/another-way-to-implement-envoy-filter"))))}p.isMDXComponent=!0}}]);