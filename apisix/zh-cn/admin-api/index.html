<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>apisix/zh-cn/admin-api · Apache APISIX™</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;!--"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="apisix/zh-cn/admin-api · Apache APISIX™"/><meta property="og:type" content="website"/><meta property="og:url" content="https://apisix.apache.org//"/><meta property="og:description" content="&lt;!--"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://apisix.apache.org/blog/atom.xml" title="Apache APISIX™ Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://apisix.apache.org/blog/feed.xml" title="Apache APISIX™ Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Apache APISIX™"/><h2 class="headerTitleWithLogo">Apache APISIX™</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/subscribe-guide" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/downloads" target="_self">Downloads</a></li><li class=""><a href="/team" target="_self">Team</a></li><li class=""><a href="/help" target="_self">Help</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">apisix/zh-cn/admin-api</h1></header><article><div><span><!--
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
-->
<h1><a class="anchor" aria-hidden="true" id="目录"></a><a href="#目录" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录</h1>
<ul>
<li><a href="#route">Route</a></li>
<li><a href="#service">Service</a></li>
<li><a href="#consumer">Consumer</a></li>
<li><a href="#upstream">Upstream</a></li>
<li><a href="#ssl">SSL</a></li>
<li><a href="#plugin-metadata">Plugin Metadata</a></li>
<li><a href="#plugin">Plugin</a></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="route"></a><a href="#route" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Route</h2>
<p><em>地址</em>：/apisix/admin/routes/{id}?ttl=0</p>
<p><em>说明</em>：Route 字面意思就是路由，通过定义一些规则来匹配客户端的请求，然后根据匹配结果加载并执行相应的
插件，并把请求转发给到指定 Upstream。</p>
<blockquote>
<p>请求方法：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>请求 uri</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/routes</td><td>无</td><td>获取资源列表</td></tr>
<tr><td>GET</td><td>/apisix/admin/routes/{id}</td><td>无</td><td>获取资源</td></tr>
<tr><td>PUT</td><td>/apisix/admin/routes/{id}</td><td>{...}</td><td>根据 id 创建资源</td></tr>
<tr><td>POST</td><td>/apisix/admin/routes</td><td>{...}</td><td>创建资源，id 由后台服务自动生成</td></tr>
<tr><td>DELETE</td><td>/apisix/admin/routes/{id}</td><td>无</td><td>删除资源</td></tr>
<tr><td>PATCH</td><td>/apisix/admin/routes/{id}</td><td>{...}</td><td>标准 PATCH ，修改已有 Route 的部分属性，其他不涉及的属性会原样保留；如果你要删除某个属性，将该属性的值设置为null 即可删除；特别地，当需要修改属性的值为数组时，该属性将全量更新</td></tr>
<tr><td>PATCH</td><td>/apisix/admin/routes/{id}/{path}</td><td>{...}</td><td>SubPath PATCH，通过 {path} 指定 Route 要更新的属性，全量更新该属性的数据，其他不涉及的属性会原样保留。两种 PATCH 的区别可以参考后面的示例</td></tr>
</tbody>
</table>
<blockquote>
<p>URL 请求参数：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>类型</th><th>说明</th><th>示例</th></tr>
</thead>
<tbody>
<tr><td>ttl</td><td>可选</td><td>辅助</td><td>超过这个时间会被自动删除，单位：秒</td><td>ttl=1</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>类型</th><th>说明</th><th>示例</th></tr>
</thead>
<tbody>
<tr><td>uri</td><td>与 <code>uris</code> 二选一</td><td>匹配规则</td><td>除了如 <code>/foo/bar</code>、<code>/foo/gloo</code> 这种全量匹配外，使用不同 <a href="/apisix/zh-cn/architecture-design#router">Router</a> 还允许更高级匹配，更多见 <a href="/apisix/zh-cn/architecture-design#router">Router</a>。</td><td>&quot;/hello&quot;</td></tr>
<tr><td>uris</td><td>与 <code>uri</code> 二选一</td><td>匹配规则</td><td>非空数组形式，可以匹配多个 <code>uri</code></td><td>[&quot;/hello&quot;, &quot;/world&quot;]</td></tr>
<tr><td>plugins</td><td><code>plugins</code>、<code>script</code>、<code>upstream</code>/<code>upstream_id</code>、<code>service_id</code>至少选择一个</td><td>Plugin</td><td>详见 <a href="/apisix/zh-cn/architecture-design#plugin">Plugin</a></td><td></td></tr>
<tr><td>script</td><td><code>plugins</code>、<code>script</code>、<code>upstream</code>/<code>upstream_id</code>、<code>service_id</code>至少选择一个</td><td>Script</td><td>详见 <a href="/apisix/zh-cn/architecture-design#script">Script</a></td><td></td></tr>
<tr><td>upstream</td><td><code>plugins</code>、<code>script</code>、<code>upstream</code>/<code>upstream_id</code>、<code>service_id</code>至少选择一个</td><td>Upstream</td><td>启用的 Upstream 配置，详见 <a href="/apisix/zh-cn/architecture-design#upstream">Upstream</a></td><td></td></tr>
<tr><td>upstream_id</td><td><code>plugins</code>、<code>script</code>、<code>upstream</code>/<code>upstream_id</code>、<code>service_id</code>至少选择一个</td><td>Upstream</td><td>启用的 upstream id，详见 <a href="/apisix/zh-cn/architecture-design#upstream">Upstream</a></td><td></td></tr>
<tr><td>service_id</td><td><code>plugins</code>、<code>script</code>、<code>upstream</code>/<code>upstream_id</code>、<code>service_id</code>至少选择一个</td><td>Service</td><td>绑定的 Service 配置，详见 <a href="/apisix/zh-cn/architecture-design#service">Service</a></td><td></td></tr>
<tr><td>service_protocol</td><td>可选</td><td>上游协议类型</td><td>只可以是 &quot;grpc&quot;, &quot;http&quot; 二选一。</td><td>默认 &quot;http&quot;，使用gRPC proxy 或gRPC transcode 时，必须用&quot;grpc&quot;</td></tr>
<tr><td>name</td><td>可选</td><td>辅助</td><td>标识路由名称</td><td>route-xxxx</td></tr>
<tr><td>desc</td><td>可选</td><td>辅助</td><td>标识描述、使用场景等。</td><td>客户 xxxx</td></tr>
<tr><td>host</td><td>可选</td><td>匹配规则</td><td>当前请求域名，比如 <code>foo.com</code>；也支持泛域名，比如 <code>*.foo.com</code>。</td><td>&quot;foo.com&quot;</td></tr>
<tr><td>hosts</td><td>可选</td><td>匹配规则</td><td>非空列表形态的 <code>host</code>，表示允许有多个不同 <code>host</code>，匹配其中任意一个即可。</td><td>{&quot;foo.com&quot;, &quot;*.bar.com&quot;}</td></tr>
<tr><td>remote_addr</td><td>可选</td><td>匹配规则</td><td>客户端请求 IP 地址: <code>192.168.1.101</code>、<code>192.168.1.102</code> 以及 CIDR 格式的支持 <code>192.168.1.0/24</code>。特别的，APISIX 也完整支持 IPv6 地址匹配：<code>::1</code>，<code>fe80::1</code>, <code>fe80::1/64</code> 等。</td><td>&quot;192.168.1.0/24&quot;</td></tr>
<tr><td>remote_addrs</td><td>可选</td><td>匹配规则</td><td>非空列表形态的 <code>remote_addr</code>，表示允许有多个不同 IP 地址，符合其中任意一个即可。</td><td>{&quot;127.0.0.1&quot;, &quot;192.0.0.0/8&quot;, &quot;::1&quot;}</td></tr>
<tr><td>methods</td><td>可选</td><td>匹配规则</td><td>如果为空或没有该选项，代表没有任何 <code>method</code> 限制，也可以是一个或多个的组合：<code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>PATCH</code>, <code>HEAD</code>, <code>OPTIONS</code>，<code>CONNECT</code>，<code>TRACE</code>。</td><td>{&quot;GET&quot;, &quot;POST&quot;}</td></tr>
<tr><td>priority</td><td>可选</td><td>匹配规则</td><td>如果不同路由包含相同 <code>uri</code>，根据属性 <code>priority</code> 确定哪个 <code>route</code> 被优先匹配，值越大优先级越高，默认值为 0。</td><td>priority = 10</td></tr>
<tr><td>vars</td><td>可选</td><td>匹配规则</td><td>由一个或多个<code>{var, operator, val}</code>元素组成的列表，类似这样：<code>{{var, operator, val}, {var, operator, val}, ...}}</code>。例如：<code>{&quot;arg_name&quot;, &quot;==&quot;, &quot;json&quot;}</code>，表示当前请求参数 <code>name</code> 是 <code>json</code>。这里的 <code>var</code> 与 Nginx 内部自身变量命名是保持一致，所以也可以使用 <code>request_uri</code>、<code>host</code> 等。更多细节请参考<a href="https://github.com/api7/lua-resty-expr">lua-resty-expr</a></td><td>{{&quot;arg_name&quot;, &quot;==&quot;, &quot;json&quot;}, {&quot;arg_age&quot;, &quot;&gt;&quot;, 18}}</td></tr>
<tr><td>filter_func</td><td>可选</td><td>匹配规则</td><td>用户自定义的过滤函数。可以使用它来实现特殊场景的匹配要求实现。该函数默认接受一个名为 vars 的输入参数，可以用它来获取 Nginx 变量。</td><td>function(vars) return vars[&quot;arg_name&quot;] == &quot;json&quot; end</td></tr>
<tr><td>labels</td><td>可选</td><td>匹配规则</td><td>标识附加属性的键值对</td><td>{&quot;version&quot;:&quot;v2&quot;,&quot;build&quot;:&quot;16&quot;,&quot;env&quot;:&quot;production&quot;}</td></tr>
<tr><td>enable_websocket</td><td>可选</td><td>辅助</td><td>是否启用 <code>websocket</code>(boolean), 缺省 <code>false</code>.</td><td></td></tr>
<tr><td>status</td><td>可选</td><td>辅助</td><td>是否启用此路由, 缺省 <code>1</code>。</td><td><code>1</code> 表示启用，<code>0</code> 表示禁用</td></tr>
<tr><td>create_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
<tr><td>update_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
</tbody>
</table>
<p>有两点需要特别注意：</p>
<ul>
<li>除了 <code>uri</code>/<code>uris</code> 是必选的之外，<code>plugins</code>、<code>script</code>、<code>upstream</code>/<code>upstream_id</code>、<code>service_id</code> 这三类必须选择其中至少一个。</li>
<li>对于同一类参数比如 <code>uri</code>与 <code>uris</code>，<code>upstream</code> 与 <code>upstream_id</code>，<code>host</code> 与 <code>hosts</code>，<code>remote_addr</code> 与 <code>remote_addrs</code> 等，是不能同时存在，二者只能选择其一。如果同时启用，接口会报错。</li>
</ul>
<p>route 对象 json 配置内容：</p>
<pre><code class="hljs css language-shell">{
    "id": "1",                  # id，非必填
    "uris": ["/a","/b"],        # 一组 URL 路径
    "methods": ["GET","POST"],  # 可以填多个方法
    "hosts": ["a.com","b.com"], # 一组 host 域名
    "plugins": {},              # 指定 route 绑定的插件
    "priority": 0,              # apisix 支持多种匹配方式，可能会在一次匹配中同时匹配到多条路由，此时优先级高的优先匹配中
    "name": "路由xxx",
    "desc": "hello world",
    "remote_addrs": ["127.0.0.1"],  # 一组客户端请求 IP 地址
    "vars": [],                 # 由一个或多个 {var, operator, val} 元素组成的列表
    "upstream_id": "1",         # upstream 对象在 etcd 中的 id ，建议使用此值
    "upstream": {},             # upstream 信息对象，建议尽量不要使用
    "filter_func": "",          # 用户自定义的过滤函数，非必填
}
</code></pre>
<p>具体示例：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> 创建一个路由</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -i -d <span class="hljs-string">'</span></span>
{
    "uri": "/index.html",
    "hosts": ["foo.com", "*.bar.com"],
    "remote_addrs": ["127.0.0.0/8"],
    "methods": ["PUT", "GET"],
    "enable_websocket": true,
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "39.97.63.215:80": 1
        }
    }
}'

HTTP/1.1 201 Created
Date: Sat, 31 Aug 2019 01:17:15 GMT
...
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"> 创建一个有效期为 60 秒的路由，过期后自动删除</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/routes/2?ttl=60 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PUT -i -d '</span></span>
{
    "uri": "/aa/index.html",
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "39.97.63.215:80": 1
        }
    }
}'

HTTP/1.1 201 Created
Date: Sat, 31 Aug 2019 01:17:15 GMT
...
<span class="hljs-meta">

#</span><span class="bash"> 给路由增加一个 upstream node</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "upstream": {
        "nodes": {
            "39.97.63.216:80": 1
        }
    }
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将更新为：
{
    "39.97.63.215:80": 1,
    "39.97.63.216:80": 1
}
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 给路由更新一个 upstream node 的权重</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span></span>
{
    "upstream": {
        "nodes": {
            "39.97.63.216:80": 10
        }
    }
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将更新为：
{
    "39.97.63.215:80": 1,
    "39.97.63.216:80": 10
}
<span class="hljs-meta">

#</span><span class="bash"> 给路由删除一个 upstream node</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "upstream": {
        "nodes": {
            "39.97.63.215:80": null
        }
    }
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将更新为：
{
    "39.97.63.216:80": 10
}
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 替换路由的 methods -- 数组</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span>{</span>
    "methods": ["GET", "POST"]
}'
HTTP/1.1 200 OK
...

执行成功后，methods 将不保留原来的数据，整个更新为：
["GET", "POST"]
<span class="hljs-meta">

#</span><span class="bash"> 替换路由的 upstream nodes -- sub path</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1/upstream/nodes -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "39.97.63.200:80": 1
}'
HTTP/1.1 200 OK
...

执行成功后，nodes 将不保留原来的数据，整个更新为：
{
    "39.97.63.200:80": 1
}
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 替换路由的 methods  -- sub path</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/routes/1/methods -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span>[<span class="hljs-string">"POST"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"PATCH"</span>]<span class="hljs-string">'</span></span>
HTTP/1.1 200 OK
...

执行成功后，methods 将不保留原来的数据，整个更新为：
["POST", "DELETE", "PATCH"]
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 禁用路由</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span></span>
{
    "status": 0
}'
HTTP/1.1 200 OK
...

执行成功后，status 将更新为：
{
    "status": 0
}
<span class="hljs-meta">

#</span><span class="bash"> 启用路由</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "status": 1
}'
HTTP/1.1 200 OK
...

执行成功后，status 将更新为：
{
    "status": 1
}


</code></pre>
<blockquote>
<p>应答参数</p>
</blockquote>
<p>目前是直接返回与 etcd 交互后的结果。</p>
<p><a href="#目录">Back to TOC</a></p>
<h2><a class="anchor" aria-hidden="true" id="service"></a><a href="#service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Service</h2>
<p><em>地址</em>：/apisix/admin/services/{id}</p>
<p><em>说明</em>：<code>Service</code> 是某类 API 的抽象（也可以理解为一组 Route 的抽象）。它通常与上游服务抽象是一一对应的，<code>Route</code>
与 <code>Service</code> 之间，通常是 N:1 的关系。</p>
<blockquote>
<p>请求方法：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>请求 uri</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/services</td><td>无</td><td>获取资源列表</td></tr>
<tr><td>GET</td><td>/apisix/admin/services/{id}</td><td>无</td><td>获取资源</td></tr>
<tr><td>PUT</td><td>/apisix/admin/services/{id}</td><td>{...}</td><td>根据 id 创建资源</td></tr>
<tr><td>POST</td><td>/apisix/admin/services</td><td>{...}</td><td>创建资源，id 由后台服务自动生成</td></tr>
<tr><td>DELETE</td><td>/apisix/admin/services/{id}</td><td>无</td><td>删除资源</td></tr>
<tr><td>PATCH</td><td>/apisix/admin/services/{id}</td><td>{...}</td><td>标准 PATCH ，修改已有 Service 的部分属性，其他不涉及的属性会原样保留；如果你要删除某个属性，将该属性的值设置为null 即可删除；特别地，当需要修改属性的值为数组时，该属性将全量更新</td></tr>
<tr><td>PATCH</td><td>/apisix/admin/services/{id}/{path}</td><td>{...}</td><td>SubPath PATCH，通过 {path} 指定 Service 需要更新的属性，全量更新该属性的数据，其他不涉及的属性会原样保留</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>类型</th><th>说明</th><th>示例</th></tr>
</thead>
<tbody>
<tr><td>plugins</td><td>可选</td><td>Plugin</td><td>详见 <a href="/apisix/zh-cn/architecture-design#plugin">Plugin</a></td><td></td></tr>
<tr><td>upstream</td><td>upstream 或 upstream_id 两个选一个</td><td>Upstream</td><td>启用的 Upstream 配置，详见 <a href="/apisix/zh-cn/architecture-design#upstream">Upstream</a></td><td></td></tr>
<tr><td>upstream_id</td><td>upstream 或 upstream_id 两个选一个</td><td>Upstream</td><td>启用的 upstream id，详见 <a href="/apisix/zh-cn/architecture-design#upstream">Upstream</a></td><td></td></tr>
<tr><td>name</td><td>可选</td><td>辅助</td><td>标识服务名称。</td><td></td></tr>
<tr><td>desc</td><td>可选</td><td>辅助</td><td>服务描述、使用场景等。</td><td></td></tr>
<tr><td>labels</td><td>可选</td><td>匹配规则</td><td>标识附加属性的键值对</td><td>{&quot;version&quot;:&quot;v2&quot;,&quot;build&quot;:&quot;16&quot;,&quot;env&quot;:&quot;production&quot;}</td></tr>
<tr><td>enable_websocket</td><td>可选</td><td>辅助</td><td>是否启用 <code>websocket</code>(boolean), 缺省 <code>false</code>.</td><td></td></tr>
<tr><td>create_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
<tr><td>update_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
</tbody>
</table>
<p>serivce 对象 json 配置内容：</p>
<pre><code class="hljs css language-shell">{
    "id": "1",              # id
    "plugins": {},          # 指定 service 绑定的插件
    "upstream_id": "1",     # upstream 对象在 etcd 中的 id ，建议使用此值
    "upstream": {},         # upstream 信息对象，不建议使用
    "name": "测试svc",  # service 名称
    "desc": "hello world",  # service 描述
    "enable_websocket": true, #启动 websocket 功能
}
</code></pre>
<p>具体示例：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> 创建一个Service</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/services/201  -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -i -d <span class="hljs-string">'</span></span>
{
    "plugins": {
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    },
    "enable_websocket": true,
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "39.97.63.215:80": 1
        }
    }
}'
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"> 返回结果</span></span>

HTTP/1.1 201 Created
...
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 给 Service 增加一个 upstream node</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/services/201 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span></span>
{
    "upstream": {
        "nodes": {
            "39.97.63.216:80": 1
        }
    }
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将更新为：
{
    "39.97.63.215:80": 1,
    "39.97.63.216:80": 1
}
<span class="hljs-meta">

#</span><span class="bash"> 给 Service 更新一个 upstream node 的权重</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/services/201 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "upstream": {
        "nodes": {
            "39.97.63.216:80": 10
        }
    }
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将更新为：
{
    "39.97.63.215:80": 1,
    "39.97.63.216:80": 10
}
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 给 Service 删除一个 upstream node</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/services/201 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span></span>
{
    "upstream": {
        "nodes": {
            "39.97.63.215:80": null
        }
    }
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将更新为：
{
    "39.97.63.216:80": 10
}
<span class="hljs-meta">

#</span><span class="bash"> 替换 Service 的 upstream nodes</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/services/201/upstream/nodes -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "39.97.63.200:80": 1
}'
HTTP/1.1 200 OK
...

执行成功后，upstream nodes 将不保留原来的数据，整个更新为：
{
    "39.97.63.200:80": 1
}

</code></pre>
<blockquote>
<p>应答参数</p>
</blockquote>
<p>目前是直接返回与 etcd 交互后的结果。</p>
<p><a href="#目录">Back to TOC</a></p>
<h2><a class="anchor" aria-hidden="true" id="consumer"></a><a href="#consumer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Consumer</h2>
<p><em>地址</em>：/apisix/admin/consumers/{username}</p>
<p><em>说明</em>：Consumer 是某类服务的消费者，需与用户认证体系配合才能使用。Consumer 使用 <code>username</code> 作为唯一标识，只支持使用 HTTP <code>PUT</code> 方法创建 Consumer。</p>
<blockquote>
<p>请求方法：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>请求 uri</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/consumers</td><td>无</td><td>获取资源列表</td></tr>
<tr><td>GET</td><td>/apisix/admin/consumers/{id}</td><td>无</td><td>获取资源</td></tr>
<tr><td>PUT</td><td>/apisix/admin/consumers</td><td>{...}</td><td>创建资源</td></tr>
<tr><td>DELETE</td><td>/apisix/admin/consumers/{id}</td><td>无</td><td>删除资源</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>类型</th><th>说明</th><th>示例</th></tr>
</thead>
<tbody>
<tr><td>username</td><td>必需</td><td>辅助</td><td>Consumer 名称。</td><td></td></tr>
<tr><td>plugins</td><td>可选</td><td>Plugin</td><td>该 Consumer 对应的插件配置，它的优先级是最高的：Consumer &gt; Route &gt; Service。对于具体插件配置，可以参考 <a href="#plugin">Plugins</a> 章节。</td><td></td></tr>
<tr><td>desc</td><td>可选</td><td>辅助</td><td>consumer描述</td><td></td></tr>
<tr><td>labels</td><td>可选</td><td>匹配规则</td><td>标识附加属性的键值对</td><td>{&quot;version&quot;:&quot;v2&quot;,&quot;build&quot;:&quot;16&quot;,&quot;env&quot;:&quot;production&quot;}</td></tr>
<tr><td>create_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
<tr><td>update_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
</tbody>
</table>
<p>consumer 对象 json 配置内容：</p>
<pre><code class="hljs css language-shell">{
    "plugins": {},          # 指定 consumer 绑定的插件
    "username": "name",     # 必填
    "desc": "hello world",  # consumer 描述
}
</code></pre>
<p>绑定认证插件有些特别，当它需要与 consumer 联合使用时，需要提供用户名、密码等信息；另一方面，当它与 route/service 绑定时，是不需要任何参数的。因为这时候是根据用户请求数据来反向推出用户对应的是哪个 consumer</p>
<p>示例：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> 创建 Consumer ，指定认证插件 key-auth ，并开启特定插件 <span class="hljs-built_in">limit</span>-count</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/consumers  -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -i -d <span class="hljs-string">'</span></span>
{
    "username": "jack",
    "plugins": {
        "key-auth": {
            "key": "auth-one"
        },
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    }
}'
HTTP/1.1 200 OK
Date: Thu, 26 Dec 2019 08:17:49 GMT
...

{"node":{"value":{"username":"jack","plugins":{"key-auth":{"key":"auth-one"},"limit-count":{"time_window":60,"count":2,"rejected_code":503,"key":"remote_addr","policy":"local"}}},"createdIndex":64,"key":"\/apisix\/consumers\/jack","modifiedIndex":64},"prevNode":{"value":"{\"username\":\"jack\",\"plugins\":{\"key-auth\":{\"key\":\"auth-one\"},\"limit-count\":{\"time_window\":60,\"count\":2,\"rejected_code\":503,\"key\":\"remote_addr\",\"policy\":\"local\"}}}","createdIndex":63,"key":"\/apisix\/consumers\/jack","modifiedIndex":63},"action":"set"}
</code></pre>
<p>从 <code>v2.2</code> 版本之后，同一个 consumer 可以绑定多个认证插件。</p>
<blockquote>
<p>应答参数</p>
</blockquote>
<p>目前是直接返回与 etcd 交互后的结果。</p>
<p><a href="#目录">Back to TOC</a></p>
<h2><a class="anchor" aria-hidden="true" id="upstream"></a><a href="#upstream" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upstream</h2>
<p><em>地址</em>：/apisix/admin/upstreams/{id}</p>
<p><em>说明</em>：Upstream 是虚拟主机抽象，对给定的多个服务节点按照配置规则进行负载均衡。Upstream 的地址信息可以直接配置到 <code>Route</code>（或 <code>Service</code>) 上，当 Upstream 有重复时，就需要用“引用”方式避免重复了。</p>
<blockquote>
<p>请求方法：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>请求 uri</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/upstreams</td><td>无</td><td>获取资源列表</td></tr>
<tr><td>GET</td><td>/apisix/admin/upstreams/{id}</td><td>无</td><td>获取资源</td></tr>
<tr><td>PUT</td><td>/apisix/admin/upstreams/{id}</td><td>{...}</td><td>根据 id 创建资源</td></tr>
<tr><td>POST</td><td>/apisix/admin/upstreams</td><td>{...}</td><td>创建资源，id 由后台服务自动生成</td></tr>
<tr><td>DELETE</td><td>/apisix/admin/upstreams/{id}</td><td>无</td><td>删除资源</td></tr>
<tr><td>PATCH</td><td>/apisix/admin/upstreams/{id}</td><td>{...}</td><td>标准 PATCH ，修改已有 Upstream 的部分属性，其他不涉及的属性会原样保留；如果你要删除某个属性，将该属性的值设置为null 即可删除；特别地，当需要修改属性的值为数组时，该属性将全量更新</td></tr>
<tr><td>PATCH</td><td>/apisix/admin/upstreams/{id}/{path}</td><td>{...}</td><td>SubPath PATCH，通过 {path} 指定 Upstream 需要更新的属性，全量更新该属性的数据，其他不涉及的属性会原样保留。</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<p>APISIX 的 Upstream 除了基本的复杂均衡算法选择外，还支持对上游做主被动健康检查、重试等逻辑，具体看下面表格。</p>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>类型</th><th>说明</th><th>示例</th></tr>
</thead>
<tbody>
<tr><td>nodes</td><td>必需</td><td>Node</td><td>哈希表，内部元素的 key 是上游机器地址列表，格式为<code>地址 + Port</code>，其中地址部分可以是 IP 也可以是域名，比如 <code>192.168.1.100:80</code>、<code>foo.com:80</code>等。value 则是节点的权重，特别的，当权重值为 <code>0</code> 有特殊含义，通常代表该上游节点失效，永远不希望被选中。<code>nodes</code> 可以为空，这通常用作占位符。客户端命中这样的上游会返回 502。</td><td><code>192.168.1.100:80</code></td></tr>
<tr><td>type</td><td>必需</td><td>枚举</td><td><code>roundrobin</code> 支持权重的负载，<code>chash</code> 一致性哈希，两者是二选一的</td><td><code>roundrobin</code></td><td></td></tr>
<tr><td>key</td><td>条件必需</td><td>匹配类型</td><td>该选项只有类型是 <code>chash</code> 才有效。根据 <code>key</code> 来查找对应的 node <code>id</code>，相同的 <code>key</code> 在同一个对象中，永远返回相同 id，目前支持的 Nginx 内置变量有 <code>uri, server_name, server_addr, request_uri, remote_port, remote_addr, query_string, host, hostname, arg_***</code>，其中 <code>arg_***</code> 是来自URL的请求参数，<a href="http://nginx.org/en/docs/varindex.html">Nginx 变量列表</a></td><td></td></tr>
<tr><td>checks</td><td>可选</td><td>health_checker</td><td>配置健康检查的参数，详细可参考<a href="/apisix/health-check">health-check</a></td><td></td></tr>
<tr><td>retries</td><td>可选</td><td>整型</td><td>使用底层的 Nginx 重试机制将请求传递给下一个上游，默认启用重试且次数为后端 node 数量。如果指定了具体重试次数，它将覆盖默认值。<code>0</code> 代表不启用重试机制</td><td></td></tr>
<tr><td>timeout</td><td>可选</td><td>超时时间对象</td><td>设置连接、发送消息、接收消息的超时时间</td><td></td></tr>
<tr><td>hash_on</td><td>可选</td><td>辅助</td><td><code>hash_on</code> 支持的类型有 <code>vars</code>（Nginx内置变量），<code>header</code>（自定义header），<code>cookie</code>，<code>consumer</code>，默认值为 <code>vars</code></td></tr>
<tr><td>name</td><td>可选</td><td>辅助</td><td>标识上游服务名称、使用场景等。</td><td></td></tr>
<tr><td>desc</td><td>可选</td><td>辅助</td><td>上游服务描述、使用场景等。</td><td></td></tr>
<tr><td>pass_host</td><td>可选</td><td>枚举</td><td><code>pass</code> 透传客户端请求的 host, <code>node</code> 不透传客户端请求的 host, 使用 upstream node 配置的 host, <code>rewrite</code> 使用 <code>upstream_host</code> 配置的值重写 host 。</td><td></td></tr>
<tr><td>upstream_host</td><td>可选</td><td>辅助</td><td>只在 <code>pass_host</code> 配置为 <code>rewrite</code> 时有效。</td><td></td></tr>
<tr><td>labels</td><td>可选</td><td>匹配规则</td><td>标识附加属性的键值对</td><td>{&quot;version&quot;:&quot;v2&quot;,&quot;build&quot;:&quot;16&quot;,&quot;env&quot;:&quot;production&quot;}</td></tr>
<tr><td>create_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
<tr><td>update_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
</tbody>
</table>
<p><code>hash_on</code> 比较复杂，这里专门说明下：</p>
<ol>
<li>设为 <code>vars</code> 时，<code>key</code> 为必传参数，目前支持的 Nginx 内置变量有 <code>uri, server_name, server_addr, request_uri, remote_port, remote_addr, query_string, host, hostname, arg_***</code>，其中 <code>arg_***</code> 是来自URL的请求参数，<a href="http://nginx.org/en/docs/varindex.html">Nginx 变量列表</a></li>
<li>设为 <code>header</code> 时, <code>key</code> 为必传参数，其值为自定义的 header name, 即 &quot;http_<code>key</code>&quot;</li>
<li>设为 <code>cookie</code> 时, <code>key</code> 为必传参数，其值为自定义的 cookie name，即 &quot;cookie_<code>key</code>&quot;</li>
<li>设为 <code>consumer</code> 时，<code>key</code> 不需要设置。此时哈希算法采用的 <code>key</code> 为认证通过的 <code>consumer_name</code>。</li>
<li>如果指定的 <code>hash_on</code> 和 <code>key</code> 获取不到值时，就是用默认值：<code>remote_addr</code>。</li>
</ol>
<p>upstream 对象 json 配置内容：</p>
<pre><code class="hljs css language-shell">{
    "id": "1",                  # id
    "retries": 1,               # 请求重试次数
    "timeout": {                # 设置连接、发送消息、接收消息的超时时间
        "connect":15,
        "send":15,
        "read":15,
    },
    "nodes": {"host:80": 100},  # 上游机器地址列表，格式为`地址 + Port`
    "type":"roundrobin",        # chash or roundrobin
    "checks": {},               # 配置健康检查的参数
    "hash_on": "",
    "key": "",
    "name": "upstream-xxx",      # upstream 名称
    "desc": "hello world",      # upstream 描述
}
</code></pre>
<p>具体示例：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> 创建一个upstream</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/upstreams/100  -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -i -X PUT -d <span class="hljs-string">'</span></span>
{
    "type":"roundrobin",
    "nodes":{
        "127.0.0.1:80":1,
        "127.0.0.2:80":2,
        "foo.com:80":3
    }
}'
HTTP/1.1 201 Created
...
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 给 Upstream 增加一个 node</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/upstreams/100 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span></span>
{
    "nodes": {
        "39.97.63.216:80": 1
    }
}'
HTTP/1.1 200 OK
...

执行成功后，nodes 将更新为：
{
    "39.97.63.215:80": 1,
    "39.97.63.216:80": 1
}
<span class="hljs-meta">

#</span><span class="bash"> 给 Upstream 更新一个 node 的权重</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/upstreams/100 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "nodes": {
        "39.97.63.216:80": 10
    }
}'
HTTP/1.1 200 OK
...

执行成功后，nodes 将更新为：
{
    "39.97.63.215:80": 1,
    "39.97.63.216:80": 10
}
<span class="hljs-meta">

#</span><span class="bash"><span class="hljs-string"> 给 Upstream 删除一个 node</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/upstreams/100 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PATCH -i -d '</span></span>
{
    "nodes": {
        "39.97.63.215:80": null
    }
}'
HTTP/1.1 200 OK
...

执行成功后，nodes 将更新为：
{
    "39.97.63.216:80": 10
}
<span class="hljs-meta">

#</span><span class="bash"> 替换 Upstream 的  nodes</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/upstreams/100/nodes -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PATCH -i -d <span class="hljs-string">'</span></span>
{
    "39.97.63.200:80": 1
}'
HTTP/1.1 200 OK
...

执行成功后，nodes 将不保留原来的数据，整个更新为：
{
    "39.97.63.200:80": 1
}

</code></pre>
<blockquote>
<p>应答参数</p>
</blockquote>
<p>目前是直接返回与 etcd 交互后的结果。</p>
<p><a href="#目录">Back to TOC</a></p>
<h2><a class="anchor" aria-hidden="true" id="ssl"></a><a href="#ssl" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SSL</h2>
<p><em>地址</em>：/apisix/admin/ssl/{id}</p>
<p><em>说明</em>：SSL.</p>
<blockquote>
<p>请求方法：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>请求 uri</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/ssl</td><td>无</td><td>获取资源列表</td></tr>
<tr><td>GET</td><td>/apisix/admin/ssl/{id}</td><td>无</td><td>获取资源</td></tr>
<tr><td>PUT</td><td>/apisix/admin/ssl/{id}</td><td>{...}</td><td>根据 id 创建资源</td></tr>
<tr><td>POST</td><td>/apisix/admin/ssl</td><td>{...}</td><td>创建资源，id 由后台服务自动生成</td></tr>
<tr><td>DELETE</td><td>/apisix/admin/ssl/{id}</td><td>无</td><td>删除资源</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>类型</th><th>说明</th><th>示例</th></tr>
</thead>
<tbody>
<tr><td>cert</td><td>必需</td><td>证书</td><td>https 证书</td><td></td></tr>
<tr><td>key</td><td>必需</td><td>私钥</td><td>https 证书私钥</td><td></td></tr>
<tr><td>certs</td><td>可选</td><td>证书字符串数组</td><td>当你想给同一个域名配置多个证书时，除了第一个证书需要通过cert传递外，剩下的证书可以通过该参数传递上来</td><td></td></tr>
<tr><td>keys</td><td>可选</td><td>私钥字符串数组</td><td>certs 对应的证书私钥，注意要跟 certs 一一对应</td><td></td></tr>
<tr><td>snis</td><td>必需</td><td>匹配规则</td><td>非空数组形式，可以匹配多个 SNI</td><td></td></tr>
<tr><td>labels</td><td>可选</td><td>匹配规则</td><td>标识附加属性的键值对</td><td>{&quot;version&quot;:&quot;v2&quot;,&quot;build&quot;:&quot;16&quot;,&quot;env&quot;:&quot;production&quot;}</td></tr>
<tr><td>create_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
<tr><td>update_time</td><td>可选</td><td>辅助</td><td>单位为秒的 epoch 时间戳，如果不指定则自动创建</td><td>1602883670</td></tr>
<tr><td>status</td><td>可选</td><td>辅助</td><td>是否启用此SSL, 缺省 <code>1</code>。</td><td><code>1</code> 表示启用，<code>0</code> 表示禁用</td></tr>
</tbody>
</table>
<p>ssl 对象 json 配置内容：</p>
<pre><code class="hljs css language-shell">{
    "id": "1",          # id
    "cert": "cert",     # 证书
    "key": "key",       # 私钥
    "snis": ["t.com"]   # HTTPS 握手时客户端发送的 SNI
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="plugin-metadata"></a><a href="#plugin-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Plugin Metadata</h2>
<p><em>地址</em>：/apisix/admin/plugin_metadata/{plugin_name}</p>
<p><em>说明</em>: 插件元数据。</p>
<blockquote>
<p>请求方法:</p>
</blockquote>
<table>
<thead>
<tr><th>Method</th><th>请求 URI</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/plugin_metadata/{plugin_name}</td><td>无</td><td>获取资源</td></tr>
<tr><td>PUT</td><td>/apisix/admin/plugin_metadata/{plugin_name}</td><td>{...}</td><td>根据 plugin name 创建资源</td></tr>
<tr><td>DELETE</td><td>/apisix/admin/plugin_metadata/{plugin_name}</td><td>无</td><td>删除资源</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<p>一个根据插件 ({plugin_name}) 的 <code>metadata_schema</code> 定义的数据结构的 json object 。</p>
<p>例子:</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/plugin_metadata/example-plugin  -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -i -X PUT -d <span class="hljs-string">'</span></span>
{
    "skey": "val",
    "ikey": 1
}'
HTTP/1.1 201 Created
Date: Thu, 26 Dec 2019 04:19:34 GMT
Content-Type: text/plain
</code></pre>
<p><a href="#目录">Back to TOC</a></p>
<h2><a class="anchor" aria-hidden="true" id="plugin"></a><a href="#plugin" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Plugin</h2>
<p><em>地址</em>：/apisix/admin/plugins/{plugin_name}</p>
<p><em>说明</em>: 插件</p>
<blockquote>
<p>请求方法:</p>
</blockquote>
<table>
<thead>
<tr><th>名字</th><th>请求 uri</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/plugins/list</td><td>无</td><td>获取资源列表</td></tr>
<tr><td>GET</td><td>/apisix/admin/plugins/{plugin_name}</td><td>无</td><td>获取资源</td></tr>
</tbody>
</table>
<blockquote>
<p>body 请求参数：</p>
</blockquote>
<p>获取插件 ({plugin_name}) 数据结构的 json object 。</p>
<p>例子:</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">"http://127.0.0.1:9080/apisix/admin/plugins/list"</span> -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span></span>
["zipkin","request-id",...]
<span class="hljs-meta">
$</span><span class="bash"> curl <span class="hljs-string">"http://127.0.0.1:9080/apisix/admin/plugins/key-auth"</span> -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span></span>
{"properties":{"disable":{"type":"boolean"}},"additionalProperties":false,"type":"object"}
</code></pre>
<p><em>地址</em>：/apisix/admin/plugins/?all=true</p>
<p><em>说明</em>: 所有插件的所有属性，每个插件包括 <code>name</code>, <code>priority</code>, <code>type</code>, <code>schema</code>, <code>consumer_schema</code> and <code>version</code>。</p>
<blockquote>
<p>请求方法:</p>
</blockquote>
<table>
<thead>
<tr><th>Method</th><th>请求 URI</th><th>请求 body</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td>/apisix/admin/plugins?all=true</td><td>无</td><td>获取资源</td></tr>
</tbody>
</table>
<p><a href="#目录">Back to TOC</a></p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#route">Route</a></li><li><a href="#service">Service</a></li><li><a href="#consumer">Consumer</a></li><li><a href="#upstream">Upstream</a></li><li><a href="#ssl">SSL</a></li><li><a href="#plugin-metadata">Plugin Metadata</a></li><li><a href="#plugin">Plugin</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>ASF</h5><a href="https://www.apache.org/">Foundation</a><a href="https://www.apache.org/licenses/">License</a><a href="http://www.apache.org/events/current-event/">Events</a><a href="https://www.apache.org/security/">Security</a><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></div><div><h5>Community</h5><a href="https://github.com/apache/apisix/issues">GitHub Issue Tracker</a><a href="https://apisix.slack.com/">Slack</a><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/users">User Showcase</a><a href="/blog">Blog</a></div></section><a href="https://www.apache.org/" target="_blank" rel="noreferrer noopener" style="display:block;margin:1em auto;opacity:0.8;transition:opacity 0.15s ease-in-out;text-align:center"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" style="width:370px;height:64px"/></a><section class="copyright">Copyright © 2019-2020 The Apache Software Foundation. Apache APISIX, APISIX™, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZHVP417Y1Y',
                apiKey: '79e72fedcf3719ba85c552f710ade8a3',
                indexName: 'apache-apisix-website',
                inputSelector: '#search_input_react'
              });
            </script></body></html>