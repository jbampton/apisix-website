<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>apisix/plugins/traffic-split · Apache APISIX™</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;!--"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="apisix/plugins/traffic-split · Apache APISIX™"/><meta property="og:type" content="website"/><meta property="og:url" content="https://apisix.apache.org//"/><meta property="og:description" content="&lt;!--"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://apisix.apache.org/blog/atom.xml" title="Apache APISIX™ Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://apisix.apache.org/blog/feed.xml" title="Apache APISIX™ Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Apache APISIX™"/><h2 class="headerTitleWithLogo">Apache APISIX™</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/subscribe-guide" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/downloads" target="_self">Downloads</a></li><li class=""><a href="/team" target="_self">Team</a></li><li class=""><a href="/help" target="_self">Help</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">apisix/plugins/traffic-split</h1></header><article><div><span><!--
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
-->
<ul>
<li><a href="/apisix/zh-cn/plugins/traffic-split">中文</a></li>
</ul>
<h1><a class="anchor" aria-hidden="true" id="summary"></a><a href="#summary" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Summary</h1>
<ul>
<li><a href="#name"><strong>Name</strong></a></li>
<li><a href="#attributes"><strong>Attributes</strong></a></li>
<li><a href="#how-to-enable"><strong>How To Enable</strong></a></li>
<li><a href="#example"><strong>Example</strong></a>
<ul>
<li><a href="#grayscale-release"><strong>Grayscale Release</strong></a></li>
<li><a href="#blue-green-release"><strong>Blue-green Release</strong></a></li>
<li><a href="#custom-release"><strong>Custom Release</strong></a></li>
</ul></li>
<li><a href="#disable-plugin"><strong>Disable Plugin</strong></a></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="name"></a><a href="#name" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Name</h2>
<p>The traffic split plugin allows users to incrementally direct percentages of traffic between various upstreams.</p>
<p>Note: The ratio between each upstream may not so accurate since the drawback of weighted round robin algorithm (especially when the wrr state is reset).</p>
<h2><a class="anchor" aria-hidden="true" id="attributes"></a><a href="#attributes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Attributes</h2>
<table>
<thead>
<tr><th>Name</th><th>Type</th><th>Requirement</th><th>Default</th><th>Valid</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>rules.match</td><td>array[object]</td><td>optional</td><td></td><td></td><td>List of matching rules.</td></tr>
<tr><td>rules.match.vars</td><td>array[array]</td><td>optional</td><td></td><td></td><td>A list consisting of one or more {var, operator, val} elements, like this: {{var, operator, val}, {var, operator, val}, ...}}. For example: {&quot;arg_name&quot;, &quot;==&quot;, &quot;json&quot;}, which means that the current request parameter name is json. The var here is consistent with the naming of Nginx internal variables, so request_uri, host, etc. can also be used; for the operator part, the currently supported operators are ==, ~=, ~~, &gt;, &lt;, in, has and !. For specific usage of operators, please see the <code>operator-list</code> part of <a href="https://github.com/api7/lua-resty-expr#operator-list">lua-resty-expr</a>.</td></tr>
<tr><td>rules.weighted_upstreams</td><td>array[object]</td><td>optional</td><td></td><td></td><td>List of upstream configuration rules.</td></tr>
<tr><td>weighted_upstreams.upstream_id</td><td>string/integer</td><td>optional</td><td></td><td></td><td>The upstream id is bound to the corresponding upstream(not currently supported).</td></tr>
<tr><td>weighted_upstreams.upstream</td><td>object</td><td>optional</td><td></td><td></td><td>Upstream configuration information.</td></tr>
<tr><td>upstream.type</td><td>enum</td><td>optional</td><td>roundrobin</td><td>[roundrobin, chash]</td><td>roundrobin supports weighted load, chash consistent hashing, the two are alternatives.</td></tr>
<tr><td>upstream.nodes</td><td>object</td><td>optional</td><td></td><td></td><td>In the hash table, the key of the internal element is the list of upstream machine addresses, in the format of address + Port, where the address part can be an IP or a domain name, such as 192.168.1.100:80, foo.com:80, etc. value is the weight of the node. In particular, when the weight value is 0, it has special meaning, which usually means that the upstream node is invalid and never wants to be selected.</td></tr>
<tr><td>upstream.timeout</td><td>object</td><td>optional</td><td>15</td><td></td><td>Set the timeout period for connecting, sending and receiving messages (time unit: second, all default to 15 seconds).</td></tr>
<tr><td>upstream.pass_host</td><td>enum</td><td>optional</td><td>&quot;pass&quot;</td><td>[&quot;pass&quot;, &quot;node&quot;, &quot;rewrite&quot;]</td><td>pass: pass the host requested by the client, node: pass the host requested by the client; use the host configured with the upstream node, rewrite: rewrite the host with the value configured by the upstream_host.</td></tr>
<tr><td><code>upstream.name</code></td><td>string</td><td>optional</td><td></td><td></td><td>Identify the upstream service name, usage scenario, etc.</td></tr>
<tr><td>upstream.upstream_host</td><td>string</td><td>optional</td><td></td><td></td><td>Only valid when pass_host is configured as rewrite.</td></tr>
<tr><td>weighted_upstreams.weight</td><td>integer</td><td>optional</td><td>weight = 1</td><td></td><td>The traffic is divided according to the <code>weight</code> value, and the roundrobin algorithm is used to divide multiple <code>weight</code>.</td></tr>
</tbody>
</table>
<p>The traffic-split plugin is mainly composed of two parts: <code>match</code> and <code>weighted_upstreams</code>. <code>match</code> is a custom conditional rule, and <code>weighted_upstreams</code> is upstream configuration information. If you configure <code>match</code> and <code>weighted_upstreams</code> information, then after the <code>match</code> rule is verified, it will be based on the <code>weight</code> value in <code>weighted_upstreams</code>; the ratio of traffic between each upstream in the plug-in will be guided, otherwise, all traffic will be directly Reach the <code>upstream</code> configured on <code>route</code> or <code>service</code>. Of course, you can also configure only the <code>weighted_upstreams</code> part, which will directly guide the traffic ratio between each upstream in the plugin based on the <code>weight</code> value in <code>weighted_upstreams</code>.</p>
<blockquote>
<p>Note: 1. In <code>match</code>, the expression in vars is the relationship of <code>and</code>, and the relationship between multiple <code>vars</code> is the relationship of <code>or</code>.  2. There is only a <code>weight</code> value in the weighted_upstreams of the plug-in, which means reaching the upstream traffic weight value configured on <code>route</code> or <code>service</code>. Such as:</p>
</blockquote>
<pre><code class="hljs css language-json">{
    <span class="hljs-attr">"weight"</span>: <span class="hljs-number">2</span>
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="how-to-enable"></a><a href="#how-to-enable" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How To Enable</h2>
<p>Create a route and enable the <code>traffic-split</code> plugin:</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "traffic-split": {
            "rules": [
                {
                    "weighted_upstreams": [
                        {
                            "upstream": {
                                "name": "upstream_A",
                                "type": "roundrobin",
                                "nodes": {
                                    "127.0.0.1:1981":10
                                },
                                "timeout": {
                                    "connect": 15,
                                    "send": 15,
                                    "read": 15
                                }
                            },
                            "weight": 1
                        },
                        {
                            "weight": 1
                        }
                    ]
                }
            ]
        }
    },
    "upstream": {
            "type": "roundrobin",
            "nodes": {
                "127.0.0.1:1980": 1
            }
    }
}'
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="example"></a><a href="#example" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example</h2>
<h3><a class="anchor" aria-hidden="true" id="grayscale-release"></a><a href="#grayscale-release" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Grayscale Release</h3>
<p>The <code>match</code> rule part is missing, and the traffic is split according to the <code>weight</code> value configured by the <code>weighted_upstreams</code> in the plugin. Divide <code>plug-in upstream</code> and <code>route's upstream</code> according to the traffic ratio of 3:2, of which 60% of the traffic reaches the upstream of the <code>1981</code> port in the plugin, and 40% of the traffic reaches the default <code>1980</code> port on the route Upstream.</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "traffic-split": {
            "rules": [
                {
                    "weighted_upstreams": [
                        {
                            "upstream": {
                                "name": "upstream_A",
                                "type": "roundrobin",
                                "nodes": {
                                    "127.0.0.1:1981":10
                                },
                                "timeout": {
                                    "connect": 15,
                                    "send": 15,
                                    "read": 15
                                }
                            },
                            "weight": 3
                        },
                        {
                            "weight": 2
                        }
                    ]
                }
            ]
        }
    },
    "upstream": {
            "type": "roundrobin",
            "nodes": {
                "127.0.0.1:1980": 1
            }
    }
}'
</code></pre>
<p><strong>Test plugin:</strong></p>
<p>There are 5 requests, 3 requests hit the upstream of port 1981 of the plug-in, and 2 requests hit the upstream of port 1980 of <code>route</code>.</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/index.html -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8

hello 1980
<span class="hljs-meta">
$</span><span class="bash"> curl http://127.0.0.1:9080/index.html -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8

world 1981

......
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="blue-green-release"></a><a href="#blue-green-release" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Blue-green Release</h3>
<p>Get the <code>match</code> rule parameter through the request header (you can also get it through the request parameter or NGINX variable). After the <code>match</code> rule is matched, it means that all requests hit the upstream configured by the plugin, otherwise the request only hits the <code>route</code> configured upstream.</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "traffic-split": {
            "rules": [
                {
                    "match": [
                        {
                            "vars": [
                                ["http_release","==","new_release"]
                            ]
                        }
                    ],
                    "weighted_upstreams": [
                        {
                            "upstream": {
                                "name": "upstream_A",
                                "type": "roundrobin",
                                "nodes": {
                                    "127.0.0.1:1981":10
                                }
                            }
                        }
                    ]
                }
            ]
        }
    },
    "upstream": {
            "type": "roundrobin",
            "nodes": {
                "127.0.0.1:1980": 1
            }
    }
}'
</code></pre>
<p><strong>Test plugin:</strong></p>
<p>The rule of <code>match</code> is matched, and all requests hit the upstream port 1981 configured by the plugin:</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'release: new_release'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

world 1981
</code></pre>
<p>The <code>match</code> rule fails to match, and all requests hit the 1980 port upstream configured on the <code>route</code>:</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'release: old_release'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

world 1981
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="custom-release"></a><a href="#custom-release" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Release</h3>
<p>Multiple <code>vars</code> rules can be set in <code>match</code>. Multiple expressions in <code>vars</code> have an <code>add</code> relationship, and multiple <code>vars</code> rules have an <code>or</code> relationship; as long as one of the vars is required If the rule passes, the entire <code>match</code> passes.</p>
<p><strong>Example 1: Only one <code>vars</code> rule is configured, and multiple expressions in <code>vars</code> are in the relationship of <code>add</code>. In <code>weighted_upstreams</code>, the traffic is divided into 3:2 according to the value of <code>weight</code>, of which only the part of the <code>weight</code> value represents the proportion of upstream on the <code>route</code>. When <code>match</code> fails to pass, all traffic will only hit the upstream on the route.</strong></p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "traffic-split": {
            "rules": [
                {
                    "match": [
                        {
                            "vars": [
                                ["arg_name","==","jack"],
                                ["http_user-id","&gt;","23"],
                                ["http_apisix-key","~~","[a-z]+"]
                            ]
                        }
                    ],
                    "weighted_upstreams": [
                        {
                            "upstream": {
                                "name": "upstream_A",
                                "type": "roundrobin",
                                "nodes": {
                                    "127.0.0.1:1981":10
                                }
                            },
                            "weight": 3
                        },
                        {
                            "weight": 2
                        }
                    ]
                }
            ]
        }
    },
    "upstream": {
            "type": "roundrobin",
            "nodes": {
                "127.0.0.1:1980": 1
            }
    }
}'
</code></pre>
<p>The plugin sets the requested <code>match</code> rule and upstream with port <code>1981</code>, and the route has upstream with port <code>1980</code>.</p>
<p><strong>Test plugin:</strong></p>
<blockquote>
<ol>
<li>After the verification of the <code>match</code> rule is passed, 60% of the requests hit the upstream of the plug-in port 1981, and 40% of the requests hit the upstream of the 1980 port of the <code>route</code>.</li>
</ol>
</blockquote>
<p>The match rule is successfully verified, and the upstream port of <code>1981</code> is hit.</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'user-id:30'</span> -H <span class="hljs-string">'apisix-key: hello'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

world 1981
</code></pre>
<p>The match rule fails to verify, and it hits the upstream of the default port of <code>1980</code>.</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'user-id:30'</span> -H <span class="hljs-string">'apisix-key: hello'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

hello 1980
</code></pre>
<p>After 5 requests, the service of port <code>1981</code> was hit 3 times, and the service of port <code>1980</code> was hit 2 times.</p>
<p><strong>Example 2: Configure multiple <code>vars</code> rules. Multiple expressions in <code>vars</code> are <code>add</code> relationships, and multiple <code>vars</code> are <code>and</code> relationships. According to the <code>weight</code> value in <code>weighted_upstreams</code>, the traffic is divided into 3:2, where only the part of the <code>weight</code> value represents the proportion of upstream on the route. When <code>match</code> fails to pass, all traffic will only hit the upstream on the route.</strong></p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "traffic-split": {
            "rules": [
                {
                    "match": [
                        {
                            "vars": [
                                ["arg_name","==","jack"],
                                ["http_user-id","&gt;","23"],
                                ["http_apisix-key","~~","[a-z]+"]
                            ],
                            "vars": [
                                ["arg_name2","==","rose"],
                                ["http_user-id2","!","&gt;","33"],
                                ["http_apisix-key2","~~","[a-z]+"]
                            ]
                        }
                    ],
                    "weighted_upstreams": [
                        {
                            "upstream": {
                                "name": "upstream_A",
                                "type": "roundrobin",
                                "nodes": {
                                    "127.0.0.1:1981":10
                                }
                            },
                            "weight": 3
                        },
                        {
                            "weight": 2
                        }
                    ]
                }
            ]
        }
    },
    "upstream": {
            "type": "roundrobin",
            "nodes": {
                "127.0.0.1:1980": 1
            }
    }
}'
</code></pre>
<p>The plugin sets the requested <code>match</code> rule and the upstream port of <code>1981</code>, and the route has upstream port of <code>1980</code>.</p>
<p><strong>Test plugin:</strong></p>
<blockquote>
<ol>
<li>The expressions of the two <code>vars</code> are matched successfully. After the <code>match</code> rule is verified, 60% of the requests hit the 1981 port upstream of the plugin, and 40% of the requests hit the 1980 port upstream of the <code>route</code>.</li>
</ol>
</blockquote>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack&amp;name2=rose'</span> -H <span class="hljs-string">'user-id:30'</span> -H <span class="hljs-string">'user-id2:22'</span> -H <span class="hljs-string">'apisix-key: hello'</span> -H <span class="hljs-string">'apisix-key2: world'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

world 1981
</code></pre>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack&amp;name2=rose'</span> -H <span class="hljs-string">'user-id:30'</span> -H <span class="hljs-string">'user-id2:22'</span> -H <span class="hljs-string">'apisix-key: hello'</span> -H <span class="hljs-string">'apisix-key2: world'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

hello 1980
</code></pre>
<p>After 5 requests, the service of port <code>1981</code> was hit 3 times, and the service of port <code>1980</code> was hit 2 times.</p>
<blockquote>
<ol start="2">
<li>The second expression of <code>vars</code> failed to match (missing the <code>name2</code> request parameter). After the <code>match</code> rule was verified, 60% of the requests hit the plug-in's 1981 port upstream, and 40% of the request traffic hits Go upstream to the 1980 port of <code>route</code>.</li>
</ol>
</blockquote>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'user-id:30'</span> -H <span class="hljs-string">'user-id2:22'</span> -H <span class="hljs-string">'apisix-key: hello'</span> -H <span class="hljs-string">'apisix-key2: world'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

world 1981
</code></pre>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'user-id:30'</span> -H <span class="hljs-string">'user-id2:22'</span> -H <span class="hljs-string">'apisix-key: hello'</span> -H <span class="hljs-string">'apisix-key2: world'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

hello 1980
</code></pre>
<p>After 5 requests, the service of port <code>1981</code> was hit 3 times, and the service of port <code>1980</code> was hit 2 times.</p>
<blockquote>
<ol start="3">
<li>The expression verification of two <code>vars</code> failed (missing the request parameters of <code>name</code> and <code>name2</code>), the <code>match</code> rule verification failed, and the response is the upstream data <code>hello 1980</code> of the default <code>route</code>.</li>
</ol>
</blockquote>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl <span class="hljs-string">'http://127.0.0.1:9080/index.html?name=jack'</span> -H <span class="hljs-string">'user-id:30'</span> -i</span>
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
......

hello 1980
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="disable-plugin"></a><a href="#disable-plugin" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Disable Plugin</h2>
<p>When you want to remove the traffic-split plugin, it's very simple, just delete the corresponding json configuration in the plugin configuration, no need to restart the service, it will take effect immediately:</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -d <span class="hljs-string">'</span></span>
{
    "uri": "/index.html",
    "plugins": {},
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "127.0.0.1:1980": 1
        }
    }
}'
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#name">Name</a></li><li><a href="#attributes">Attributes</a></li><li><a href="#how-to-enable">How To Enable</a></li><li><a href="#example">Example</a><ul class="toc-headings"><li><a href="#grayscale-release">Grayscale Release</a></li><li><a href="#blue-green-release">Blue-green Release</a></li><li><a href="#custom-release">Custom Release</a></li></ul></li><li><a href="#disable-plugin">Disable Plugin</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>ASF</h5><a href="https://www.apache.org/">Foundation</a><a href="https://www.apache.org/licenses/">License</a><a href="https://www.apache.org/events/">Events</a><a href="https://www.apache.org/security/">Security</a><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></div><div><h5>Community</h5><a href="https://github.com/apache/apisix/issues">GitHub Issue Tracker</a><a href="https://apisix.slack.com/">Slack</a><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/users">User Showcase</a><a href="/blog">Blog</a></div></section><a href="https://www.apache.org/" target="_blank" rel="noreferrer noopener" style="display:block;margin:1em auto;opacity:0.8;transition:opacity 0.15s ease-in-out;text-align:center"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" style="width:370px;height:64px"/></a><section class="copyright">Copyright © 2019-2021 The Apache Software Foundation. Apache APISIX, APISIX™, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZHVP417Y1Y',
                apiKey: '79e72fedcf3719ba85c552f710ade8a3',
                indexName: 'apache-apisix-website',
                inputSelector: '#search_input_react'
              });
            </script></body></html>